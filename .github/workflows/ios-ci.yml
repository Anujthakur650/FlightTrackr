name: iOS CI

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  USE_MOCK_DATA: 1
  DEVELOPER_DIR: /Applications/Xcode_15.4.app/Contents/Developer

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
    
    - name: Show Xcode version
      run: xcodebuild -version
    
    - name: Cache Swift Package Manager
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    
    - name: Install XcodeGen
      run: brew install xcodegen
    
    - name: Generate Xcode project
      run: |
        cd FlightyClone
        xcodegen generate
    
    - name: Install dependencies (if using CocoaPods)
      run: |
        if [ -f "FlightyClone/Podfile" ]; then
          cd FlightyClone
          pod install
        fi
    
    - name: Build app
      run: |
        cd FlightyClone
        xcodebuild clean build \
          -scheme FlightyClone \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Run unit tests
      run: |
        cd FlightyClone
        xcodebuild test \
          -scheme FlightyClone \
          -destination 'platform=iOS Simulator,name=iPhone 15 Pro,OS=17.5' \
          -configuration Debug \
          -enableCodeCoverage YES \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO
    
    - name: Generate code coverage report
      run: |
        cd FlightyClone
        xcrun llvm-cov export \
          -format="lcov" \
          -instr-profile=$(find ~/Library/Developer/Xcode/DerivedData -name "*.profdata" | head -1) \
          $(find ~/Library/Developer/Xcode/DerivedData -name "FlightyClone" -type f | head -1) \
          > coverage.lcov || echo "Coverage generation skipped"
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./FlightyClone/coverage.lcov
        flags: unittests
        fail_ci_if_error: false
    
    - name: Archive build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
        retention-days: 7

  lint:
    name: SwiftLint
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: |
        cd FlightyClone
        swiftlint lint --reporter github-actions-logging || echo "SwiftLint not configured, skipping"

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: Backend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd Backend
        npm ci
    
    - name: Run backend tests
      run: |
        cd Backend
        npm test || echo "No backend tests configured yet"
    
    - name: Build Docker image
      run: |
        cd Backend
        docker build -t flightyclone-backend:${{ github.sha }} .
    
    - name: Test Docker image
      run: |
        docker run -d --name backend-test -p 3000:3000 flightyclone-backend:${{ github.sha }}
        sleep 5
        curl -f http://localhost:3000/health || exit 1
        docker stop backend-test
